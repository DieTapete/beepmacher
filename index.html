<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- disable zoom/scroll on mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Beep Toy</title>

  <!-- PWA / Full‑Screen meta -->
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="Beep Toy" />

  <style>
    /* ------- GLOBAL DARK THEME & NO SCROLL ------------------------------- */
    html,body{
      height:100%;margin:0;
      overflow:hidden;overscroll-behavior:none;touch-action:none;
      background:#0a0a0a;color:#fafafa;
      font-family:-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif;
      display:flex;flex-direction:column;align-items:center;justify-content:center
    }
    /* re‑enable gestures for form controls */
    input,select,button{touch-action:manipulation;}

    /* ------- COMPONENTS -------------------------------------------------- */
    video{display:none;width:90vw;max-width:480px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.6);background:#000}

    button{margin-top:1rem;padding:12px 20px;font-size:1rem;border:0;border-radius:8px;background:#007aff;color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.5)}

    #status{margin-top:.75rem;color:#d0d0d0;font-size:.9rem;text-align:center;max-width:90vw}
    #toggleUiBtn{margin-top:.5rem;font-size:.8rem;background:#5c5c5e}

    #controls{display:none;margin-top:.75rem;width:90vw;max-width:480px;font-size:.8rem;color:#fafafa}
    #controls label{display:block;margin-bottom:4px}
    #controls select,#controls input{width:100%;background:#1e1e1e;color:#fafafa;border:1px solid #444;border-radius:6px;padding:4px}

    #log{display:none;margin-top:.75rem;list-style:none;padding:0;width:90vw;max-width:480px;font-size:.8rem;color:#fafafa}
    #log li{background:#1e1e1e;border-radius:6px;padding:4px 8px;margin-bottom:4px;box-shadow:0 1px 3px rgba(0,0,0,.6)}
  </style>
</head>
<body>
  <video id="video" playsinline muted></video>
  <button id="startBtn">Start Camera</button>
  <div id="status">Tap the button and allow camera access.<br>The camera is only used to detect brightness.</div>
  <button id="toggleUiBtn">Show Controls</button>

  <!-- hidden controls -->
  <div id="controls">
    <label>Brightness threshold: <span id="thresholdValue">90</span></label>
    <input id="thresholdSlider" type="range" min="10" max="255" value="90" step="1">

    <label style="margin-top:8px;">Sound:</label>
    <select id="soundSelect">
      <option value="1000" selected>Beep (1 kHz)</option>
      <option value="500">Low (0.5 kHz)</option>
      <option value="1500">High (1.5 kHz)</option>
      <option value="2000">Ultra (2 kHz)</option>
    </select>
  </div>

  <ul id="log"></ul>

  <!-- === JS remains unchanged (objects: CFG, UI, AudioSys, Vision, boot) === -->
  <script>
  const CFG={DEFAULT_THRESHOLD:90,COOLDOWN_MS:800,CANVAS:{w:120,h:90},SAMPLE_STEP:16,DEFAULT_FREQ:1000};
  if('serviceWorker'in navigator){navigator.serviceWorker.register('sw.js').catch(e=>console.log('SW fail',e));}
  const UI=(()=>{const e={video:video,startBtn:startBtn,status:status,log:log,toggle:toggleUiBtn,controls:controls,threshSlider:thresholdSlider,threshVal:thresholdValue,soundSelect:soundSelect};const m=[];const setStatus=t=>e.status.textContent=t;function logMsg(t){const time=new Date().toLocaleTimeString();m.push(`[${time}] ${t}`);if(m.length>5)m.shift();e.log.innerHTML=m.map(v=>`<li>${v}</li>`).join('');}function toggleUI(){const v=e.video.style.display!=='none';const d=v?'none':'block';['video','log','controls'].forEach(k=>e[k].style.display=d);e.toggle.textContent=v?'Show Controls':'Hide Controls';}function initControls(th,snd){e.threshSlider.addEventListener('input',()=>{const v=+e.threshSlider.value;e.threshVal.textContent=v;th(v);});e.soundSelect.addEventListener('change',()=>snd(+e.soundSelect.value));e.toggle.addEventListener('click',toggleUI);}return{els:e,setStatus,log:logMsg,initControls};})();
  const AudioSys=(()=>{let ctx;const buf={};let freq=CFG.DEFAULT_FREQ;const ensure=()=>{if(!ctx)ctx=new(window.AudioContext||window.webkitAudioContext)()};const mk=f=>{const l=ctx.sampleRate*0.2,b=ctx.createBuffer(1,l,ctx.sampleRate),d=b.getChannelData(0);for(let i=0;i<l;i++)d[i]=Math.sin(2*Math.PI*f*i/ctx.sampleRate);return b};const get=f=>buf[f]||(buf[f]=mk(f));const set=f=>{freq=f;UI.log(`Sound ${f} Hz`)};const beep=()=>{if(!ctx)return;if(ctx.state==='suspended')ctx.resume();const s=ctx.createBufferSource();s.buffer=get(freq);s.connect(ctx.destination);s.start();s.onended=()=>s.disconnect();};return{init:ensure,setFreq:set,beep};})();
  const Vision=(()=>{let cv,ct,det=false,last=0,thr=CFG.DEFAULT_THRESHOLD;const avg=f=>{const d=f.data;let s=0;for(let i=0;i<d.length;i+=CFG.SAMPLE_STEP)s+=d[i]*0.2126+d[i+1]*0.7152+d[i+2]*0.0722;return s/(d.length/CFG.SAMPLE_STEP)};const loop=()=>{if(!det)return;ct.drawImage(UI.els.video,0,0,cv.width,cv.height);const b=avg(ct.getImageData(0,0,cv.width,cv.height));const n=performance.now();if(b<thr&&n-last>CFG.COOLDOWN_MS){AudioSys.beep();last=n;}if(document.visibilityState==='visible')requestAnimationFrame(loop);};return{init:()=>{cv=document.createElement('canvas');cv.width=CFG.CANVAS.w;cv.height=CFG.CANVAS.h;ct=cv.getContext('2d');},start:()=>{det=true;loop();},setThreshold:v=>thr=v};})();
  (function(){UI.initControls(Vision.setThreshold,AudioSys.setFreq);async function start(){if(!navigator.mediaDevices?.getUserMedia){UI.setStatus('getUserMedia unsupported');return;}try{AudioSys.init();AudioSys.beep();const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});UI.els.video.srcObject=s;await UI.els.video.play();UI.setStatus('Detecting…');UI.log('Camera started');Vision.init();Vision.start();UI.els.startBtn.style.display='none';}catch(e){UI.setStatus(e.message);UI.log(e.message);}}document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='visible')Vision.start();});UI.els.startBtn.addEventListener('click',start);}());
  </script>
</body>
</html>
