<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Beep Toy</title>

  <!-- PWA / Full‑Screen meta -->
  <meta name="theme-color" content="#007aff" />
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Beep Toy" />

  <style>
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif;background:#f5f5f7;display:flex;flex-direction:column;align-items:center;justify-content:center}
    video{display:none;width:90vw;max-width:480px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.15);background:#000}
    button{margin-top:1rem;padding:12px 20px;font-size:1rem;border:0;border-radius:8px;background:#007aff;color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    #status{margin-top:.75rem;color:#555;font-size:.9rem;text-align:center;max-width:90vw}
    #toggleUiBtn{margin-top:.5rem;font-size:.8rem;background:#8e8e93}
    #controls{display:none;margin-top:.75rem;width:90vw;max-width:480px;font-size:.8rem;color:#333}
    #controls label{display:block;margin-bottom:4px}
    #controls select,#controls input{width:100%}
    #log{display:none;margin-top:.75rem;list-style:none;padding:0;width:90vw;max-width:480px;font-size:.8rem;color:#333}
    #log li{background:#fff;border-radius:6px;padding:4px 8px;margin-bottom:4px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
  </style>
</head>
<body>
  <video id="video" playsinline muted></video>
  <button id="startBtn">Start Camera</button>
  <div id="status">Tap the button and allow camera access.<br>The camera is only used to detect brightness.</div>
  <button id="toggleUiBtn">Show Controls</button>

  <!-- hidden controls -->
  <div id="controls">
    <label>Brightness threshold: <span id="thresholdValue">90</span></label>
    <input id="thresholdSlider" type="range" min="10" max="255" value="90" step="1">

    <label style="margin-top:8px;">Sound:</label>
    <select id="soundSelect">
      <option value="1000" selected>Beep (1 kHz)</option>
      <option value="500">Low (0.5 kHz)</option>
      <option value="1500">High (1.5 kHz)</option>
      <option value="2000">Ultra (2 kHz)</option>
    </select>
  </div>

  <ul id="log"></ul>

  <script>
  /* ========================= CONFIG ======================================= */
  const CFG = {
    DEFAULT_THRESHOLD: 90,
    COOLDOWN_MS: 800,
    CANVAS: { w: 120, h: 90 },
    SAMPLE_STEP: 16,
    DEFAULT_FREQ: 1000
  };

  /* ========================= SERVICE WORKER =============================== */
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(err => console.log('SW register failed', err));
  }

  /* ========================= UI MODULE ==================================== */
  const UI = (()=>{
    const els = {
      video: document.getElementById('video'),
      startBtn: document.getElementById('startBtn'),
      status: document.getElementById('status'),
      log: document.getElementById('log'),
      toggle: document.getElementById('toggleUiBtn'),
      controls: document.getElementById('controls'),
      threshSlider: document.getElementById('thresholdSlider'),
      threshVal: document.getElementById('thresholdValue'),
      soundSelect: document.getElementById('soundSelect')
    };
    const messages = [];

    function setStatus(msg){ els.status.textContent = msg; }

    function log(msg){
      const time = new Date().toLocaleTimeString();
      messages.push(`[${time}] ${msg}`);
      if(messages.length>5) messages.shift();
      els.log.innerHTML = messages.map(m=>`<li>${m}</li>`).join('');
    }

    function toggleInterface(){
      const visible = els.video.style.display !== 'none';
      const display = visible ? 'none':'block';
      ['video','log','controls'].forEach(k=>els[k].style.display = display);
      els.toggle.textContent = visible? 'Show Controls':'Hide Controls';
    }

    function initControls(onThresholdChange,onSoundChange){
      els.threshSlider.addEventListener('input',()=>{
        const val = Number(els.threshSlider.value);
        els.threshVal.textContent = val;
        onThresholdChange(val);
      });
      els.soundSelect.addEventListener('change',()=>{
        onSoundChange(Number(els.soundSelect.value));
      });
      els.toggle.addEventListener('click', toggleInterface);
    }

    return { els, setStatus, log, initControls, toggleInterface };
  })();

  /* ========================= AUDIO MODULE ================================= */
  const AudioSys = (()=>{
    let ctx=null;
    const buffers={};
    let freq = CFG.DEFAULT_FREQ;

    function _ensureCtx(){ if(!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)(); }

    function _createBuffer(frequency){
      const len = ctx.sampleRate*0.2;
      const buf = ctx.createBuffer(1,len,ctx.sampleRate);
      const data = buf.getChannelData(0);
      for(let i=0;i<len;i++){ data[i]=Math.sin(2*Math.PI*frequency*i/ctx.sampleRate); }
      return buf;
    }

    function _getBuffer(frequency){ return buffers[frequency] ||= _createBuffer(frequency); }

    function setFreq(f){ freq=f; UI.log(`Sound frequency set to ${f} Hz`);}    

    function beep(){
      if(!ctx) return;
      if(ctx.state==='suspended') ctx.resume();
      const src = ctx.createBufferSource();
      src.buffer = _getBuffer(freq);
      src.connect(ctx.destination);
      src.start();
      src.onended=()=>src.disconnect();
      UI.log(`Beep (${freq} Hz)`);
    }

    return { init: _ensureCtx, setFreq, beep };
  })();

  /* ========================= VISION MODULE ================================ */
  const Vision = (()=>{
    let canvas, ctx;
    let detecting=false, lastBeep=0, threshold=CFG.DEFAULT_THRESHOLD;

    function _avgBrightness(frame){
      const d=frame.data; let sum=0;
      for(let i=0;i<d.length;i+=CFG.SAMPLE_STEP){ sum += d[i]*0.2126 + d[i+1]*0.7152 + d[i+2]*0.0722; }
      return sum/(d.length/CFG.SAMPLE_STEP);
    }

    function _detect(){
      if(!detecting) return;
      ctx.drawImage(UI.els.video,0,0,canvas.width,canvas.height);
      const bright=_avgBrightness(ctx.getImageData(0,0,canvas.width,canvas.height));
      const now=performance.now();
      if(bright<threshold && now-lastBeep>CFG.COOLDOWN_MS){ AudioSys.beep(); lastBeep=now; }
      if(document.visibilityState==='visible') requestAnimationFrame(_detect);
    }

    function start(){ detecting=true; _detect(); }

    function setThreshold(t){ threshold=t; }

    function init(){
      canvas=document.createElement('canvas');
      canvas.width=CFG.CANVAS.w; canvas.height=CFG.CANVAS.h;
      ctx=canvas.getContext('2d');
    }

    return { init, start, setThreshold };
  })();

  /* ========================= BOOT ======================================== */
  (function boot(){
    const { video, startBtn } = UI.els;

    UI.initControls(Vision.setThreshold, AudioSys.setFreq);

    async function start(){
      if(!navigator.mediaDevices?.getUserMedia){ UI.setStatus('getUserMedia unsupported (need HTTPS).'); return; }
      try{
        AudioSys.init(); AudioSys.beep();
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' } });
        video.srcObject = stream; await video.play();
        UI.setStatus('Detecting… cover the lens to beep.');
        UI.log('Front camera started.');
        Vision.init(); Vision.start();
        startBtn.style.display='none';
      }catch(e){ UI.setStatus('Camera/Aud error: '+e.message); UI.log(e.message); }
    }

    document.addEventListener('visibilitychange',()=>{
      if(document.visibilityState==='visible') Vision.start();
    });

    startBtn.addEventListener('click', start);
  })();
  </script>
</body>
</html>
